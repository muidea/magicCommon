## ⚙️ 配置管理框架需求定义 (TOML + 隔离模型)

### 1. 配置项的组织方式

配置项文件采用 **TOML (.toml)** 格式，分为**全局配置**和**模块私有配置**两类，并可通过**启动环境环境变量**注入。

* **全局配置 (Global Config):**
    * `application.toml`: 存放全局默认配置和应用公共配置。
* **模块私有配置 (Module Private Config):**
    * `config.d/`: 目录，存放按模块划分的独立配置文件。
    * `config.d/moduleA.toml`
    * `config.d/moduleB.toml`
* **最高优先级注入:**
    * 启动环境环境变量。

### 2. 配置项优先级与隔离 (核心机制)

配置管理框架将所有配置项分为**合并配置树 (Merged Config Tree)** 和**模块隔离配置 (Isolated Module Config)** 两部分。

#### 2.1. 配置项优先级 (覆盖与合并规则)

1.  **优先级最高 (仅合并配置树)**: **启动环境变量**。
2.  **次优先级 (仅合并配置树)**: `application.toml`。
3.  **最低优先级 (隔离配置)**: `config.d/moduleX.toml` 文件组。

#### 2.2. 配置项读取规则 (隔离实现)

| 读取方式 | 目标配置项 (Key) | 查找范围 | 查找回退 (Fallback) | 生效配置值 |
| :--- | :--- | :--- | :--- | :--- |
| **读取全局/合并配置** | `propertyName` | **合并配置树** (`环境变量` + `application.toml`) | 查找顺序：**环境变量** $\rightarrow$ **application.toml** | 如果在环境变量中存在，则其值生效；否则如果 `application.toml` 中存在，则其值生效。 |
| **读取模块隔离配置** | `moduleName.propertyName` | 仅**目标模块文件** (`config.d/moduleName.toml`) | **无回退** | **必须**在指定的 `config.d/moduleName.toml` 文件中找到该项。如果找不到，则读取失败。**不允许**回退到 `application.toml` 或环境变量。 |

> **核心原则**: 模块配置文件 (`config.d/*.toml`) 中的配置项，不会被合并到全局配置树中，也不会互相覆盖，只能通过显式指定 `moduleName` 进行访问。

### 3. 动态配置与事件通知 (观察者模式)

框架必须提供机制来主动通知配置项的变更，使用**观察者模式**实现。

* **主动监听**: 允许系统组件注册为配置项的观察者。
* **细粒度事件**: 框架必须能够监听**特定配置路径**（无论是 `propertyName` 还是 `moduleName.propertyName`）的变更。
* **事件内容**: 变更事件应包含：配置路径 (`Key`)、旧值 (`Old Value`) 和新值 (`New Value`)。
* **事件触发**: 在系统加载配置项时，或配置项发生变更时，主动发送配置项改变事件。

### 4. 实时文件监听与热加载

配置管理框架必须能够主动监听配置文件变化，并实现健壮的热加载机制。

* **文件监听**: 监听 `application.toml` 和 `config.d/` 目录下所有配置文件的变动。
* **热加载流程**:
    1.  检测到文件变更（例如 `moduleA.toml` 变动）。
    2.  重新加载并**独立校验**受影响的文件配置（例如只校验 `moduleA.toml`）。
    3.  如果校验失败，**保持旧配置**，并记录错误日志。
    4.  如果校验成功，计算新旧配置的差异 (Diff)。
    5.  根据差异，触发第 3 点所述的**细粒度配置变更事件**，通知相关观察者。

> **健壮性要求**: 单个模块配置文件的错误或加载失败，**不得影响**其他模块或全局配置的正常运行。
